<html>
    <head>
        <title>Flask-Simple-Chat</title>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket;
           $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                
                socket.on('status', function(data) {
                    $('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                socket.on('message', function(data) {
                    $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
            });


            // kafka producer서버에 유저가 작성한 메시지 전송
            function msg_send(){

                // 유저가 작성 버튼 누른 시각 
                var today = new Date(); 

                var month = ('0' + (today.getMonth() + 1)).slice(-2);
                var day = ('0' + today.getDate()).slice(-2);
                var dateString = month  + '/' + day;  

                var hours = ('0' + today.getHours()).slice(-2); 
                var minutes = ('0' + today.getMinutes()).slice(-2);
                var timeString = hours + ':' + minutes;

                // 유저가 작성한 text 
                const text = document.getElementById('text').value;
                
                // kafka 서버에 메시지 전송
                // (각자가 만든 kafka 서버로 port 번호 바꿔야 함)
                const response = fetch("http://localhost:8989/msg_send", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        writer:"{{name}}",
                        timestamp:String(dateString)+" "+String(timeString),
                        content:String(text)
                    }),
                  })
        
                return response.then(res=>res.json());
        
            }
            async function exec(){
                var text;
                try{
                    text = await msg_send();
                    console.log(text[0].content);
                }catch(error){
                    console.log("################# 에러!!!!!!!!!!!!",error);
                }
            }

            // kafka consumer 서버에 유저가 작성한 메시지 받아오기
            /* function msg_get(){
                // kafka 서버에서 메시지 수신
                // (각자가 만든 kafka 서버로 port 번호 바꿔야 함)
                const response2 = fetch("http://localhost:8989/msg_get", {
                    method: "GET",
                  })
                //return response2.then(res=>res.text()).then(res => console.log(res));
                return response2.then(response => response.json()).then(data => console.log(data));
            }*/
            async function exec_get(){
                var text_get;
                var msg_get;
                var time_get;
                try{
                    //text_get = await msg_get();
                    text_get = await fetch("http://localhost:8989/msg_get", {method: "GET"}).then(response => response.json());
                    //console.log(text_get);
                    msg_get = text_get.content;
                    time_get = text_get.timestamp;

                    socket.emit('text', {msg: msg_get, timestamp: time_get});
                }catch(error){
                    console.log("################# 에러!!!!!!!!!!!!",error);
                }
            }




            // 유저가 방 나감
            function leave_room() {
                console.log("#################### 나감")
                socket.emit('left', {}, function() {
                    socket.disconnect();

                    // go back to the login page
                    window.location.href = "{{ url_for('main.index') }}";
                });
            }
        </script>
    </head>
    <body>
        <h1>Chat Room: {{ room }}</h1>
        <h3>edited by IML</h3>
        <textarea id="chat" cols="80" rows="20"></textarea><br><br>
        {{ name }} <input id="text" size="80" placeholder="메시지를 입력해보세요!"><br><br>
        <button onclick="msg_send();">전송</button> <br><button onclick="exec_get();">새로고침</button> <br>
        <a href="#" onclick="leave_room();">채팅방 나가기</a>

    </body>
</html>